{% extends 'projectroles/project_base.html' %}
{% load projectroles_common_tags %}
{% load rules %}
{% load crispy_forms_tags %}
{% load dict %}
{% load rules %}
{% load static %}

{% block navi_sub_project_extend %}
  <li class="breadcrumb-item active">Cases</li>
{% endblock %}

{% block projectroles %}
  <div class="row sodar-pr-content-title pb-2">
    {# Project menu dropdown, only visible if browser width < X and sidebar is hidden #}
    {% include 'projectroles/_project_menu_btn.html' %}

    <h2 class="sodar-pr-content-title">
      Cases
    </h2>
    {% include "variants/_case_list_buttons.html" %}
  </div>

  {% if project.is_remote and request.user.is_superuser %}
  <div class="container-fluid sodar-page-container">
    <div id="varfish-va-project-statistics" class="card mb-3">
      <h4 class="card-header">
        <i class="fa fa-exclamation-triangle"></i>
        Inconsistencies with Upstream Sample Sheet
      </h4>
      <div class="card-body p-3">
        {% if not project.synccaseresultmessage_set.all %}
          <p class="text-center text-muted font-italic">No inconsistencies found!</p>
        {% else %}
          <ul class="list-inline mb-0">
            {% for message in project.synccaseresultmessage_set.all %}
              {% if message.level == "debug" %}
                <li class="text-seondary">
                  <i class="fa fa-fw fa-ellipsis-h"></i>
                  {{ message.message }}
                </li>
              {% elif message.level == "warning" %}
                <li class="text-warning">
                  <i class="fa fa-fw fa-exclamation-triangle"></i>
                  {{ message.message }}
                </li>
              {% elif message.level == "error" %}
                <li class="text-danger">
                  <i class="fa fa-fw fa-exclamation-circle"></i>
                  {{ message.message }}
                </li>
              {% else %}
                <li class="text-body">
                  <i class="fa fa-fw fa-info"></i>
                  {{ message.message }}
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="container-fluid sodar-page-container">
    <div id="varfish-va-project-statistics" class="card mb-3">
      <h4 class="card-header">
        <i class="fa fa-bar-chart"></i>
        Project-wide Variant Statistics
      </h4>
      <div class="card-body p-0">
        {% if project.variant_stats %}
          <div class="row">
            <div class="col-12 col-md-6 col-lg-4">
              <div id="plot-relatedness">
                <div class="placeholder-container">
                  <div class="placeholder-text">
                    <i class="fa fa-spin fa-spinner fa-5x"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
              <div id="plot-sex-chrx-het-hom">
                <div class="placeholder-container">
                  <div class="placeholder-text">
                    <i class="fa fa-spin fa-spinner fa-5x"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
              <div id="plot-var-dps">
                <div class="placeholder-container">
                  <div class="placeholder-text">
                    <i class="fa fa-spin fa-spinner fa-5x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <p class="pt-3 text-muted text-center">
            No project-wide variant statistics yet.
            Use
            <span class="badge badge-primary">
              <i class="fa fa-refresh"></i>
              Recompute Stats
            </span>
            to compute.
          </p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="pt-0 container-fluid sodar-page-container">
    {% include 'variants/case/list.html' %}
  </div>
{% endblock %}

{% block css %}
  {{ block.super }}

  <!-- DataTables -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/ju/dt-1.10.18/b-1.5.4/datatables.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/plug-ins/1.10.18/integration/font-awesome/dataTables.fontAwesome.css" />

  <style type="text/css">
    table.varfish-card-table {
      display: inline-table;
      min-width: 100%;
      max-width: 100%;
      width: 100%;
      border-bottom: 0 !important;
    }

    .placeholder-container {
      position: relative;
      margin:0 auto;
      display: table;
      width: 100%;
      height: 300px;
    }

    .placeholder-text {
      width: 100%;
      text-align: center;
      display: table-cell;
      vertical-align: middle;
    }
  </style>
{% endblock css %}

{% block javascript %}
  {{ block.super }}
  {% if project.variant_stats %}
    <script type="text/javascript" src="{% static 'js/vendor/plotly-v1.44.1.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/vendor/axios-0.18.0.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/vendor/palette-1.1.0.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/qc_plots.js' %}"></script>

    <script type="text/javascript">
    $(function() {
      axios.get("/variants/{{ project.sodar_uuid }}/api-qc/")
        .then(function (response) {
          // Render plots after data has been loaded
          plotlyRelatedness(response, 'plot-relatedness')
          plotlySexChrxHetHom(response, 'plot-sex-chrx-het-hom')
          plotlyVarDps(response, 'plot-var-dps')
        })
    })
    </script>
  {% endif %}

  <!-- DataTables -->
  <script type="text/javascript" src="https://cdn.datatables.net/v/ju/dt-1.10.18/b-1.5.4/datatables.min.js"></script>

  <script type="text/javascript">
    $(function() {
      $("#varfish-case-table").DataTable({
        paging: false,
        sDom: "T",
        "order": [[ 1, "desc" ]]
      })
    })

    $('.varfish-case-filter').keyup(function () {
      const dt = $(this).closest('.varfish-case-list-card').find('table').dataTable()
      console.log(dt)
      const v = $(this).val()
      console.log(v)
      dt.fnFilter(v)
    })
  </script>
{% endblock %}
