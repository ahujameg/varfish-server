{% load variants_tags %}

<div class="card varfish-vars-case-details"
     id="card-varfish-vars-case-details-overview">
  <div class="card-header">
    <h4>
      <i class="fa fa-address-card-o"></i>
      Details
    </h4>
  </div>
  <ul class="list-group list-group-flush">
    <li class="list-group-item">
      <div class="row">
        <span class="col-2"><strong>
          Created At
        </strong></span>
        <span class="col-10">
          {{ object.date_created|date:"Y/m/d H:i" }}
        </span>
      </div>
    </li>
    <li class="list-group-item">
      <div class="row">
        <span class="col-2"><strong>
          Case Name
        </strong></span>
        <span class="col-10">
          {{ object.name }}
          {% include "variants/case/indicator_sex_error.html" with item=object %}
          {% include "variants/case/indicator_rel_error.html" with item=object %}
        </span>
      </div>
    </li>
    <li class="list-group-item">
      <div class="row">
        <span class="col-2"><strong>
          Individuals
        </strong></span>
        <span class="col-10">
          {% for member in object.get_members %}
            {{ member|only_source_name }}{% if not forloop.last %},{% endif %}
          {% endfor %}
        </span>
      </div>
    </li>
    <li class="list-group-item">
      <div class="row">
        <span class="col-2">
          <strong>Notes</strong>
          <div id="case-note-button" class="btn btn-sm btn-secondary ml-2">
              <span id="case-note-button-edit">
                  <i class="fa fa-pencil"></i> Edit
              </span>
              <span id="case-note-button-cancel" style="display: none;">
                  <i class="fa fa-times"></i> Cancel
              </span>
          </div>
        </span>
        <span id="case-note-text" class="col-10">
          {% if object.notes %}
            {{ object.notes }}
          {% else %}
            <em class="text-muted">No notes taken (yet).</em>
          {% endif %}
        </span>
        <span id="case-note-edit" class="col-10 text-right" style="display: none;">
          <form method="post">
            {% csrf_token %}
            {{ form }}
            <button
              type="button"
              id="case-note-save"
              class="btn btn-sm btn-secondary"
              data-url-case-notes="{{ case_notes_save_url }}"
            >
              <i class="fa fa-save"></i> Save
            </button>
          </form>
        </span>
      </div>
    </li>
  </ul>
</div>

<script type="text/javascript">
$(document).ready(function() {
  $("#case-note-button").on("click", function() {
      $("#case-note-text").toggle();
      $("#case-note-edit").toggle();
      $("#case-note-button-edit").toggle();
      $("#case-note-button-cancel").toggle();
  });
  $("#case-note-save").on("click", function() {
      $.ajax({
        type: "POST",
        url: $(this).data("url-case-notes"),
        data: $(this).closest("form").serialize(),
        dataType: "json",
        success: function(data) {
            $("#case-note-text").text(data["notes"]);
            $("#case-note-button").trigger("click");
        },
        error: function(jqXHR, textStatus, errorThrown) {
            alert("Error during AJAX call: ", jqXHR, textStatus, errorThrown);
            console.log("Error during AJAX call: ", jqXHR, textStatus, errorThrown);
        }
      });
  });
});
</script>
