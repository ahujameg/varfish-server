{# Variant filter table row #}

{% load humanize %}
{% load dict %}
{% load variants_tags %}


<tr class="variant-row {% if not training_mode %}variant-row-{{ entry|flag_class }}{% endif %}">
  {# fold-out #}
  <td class="clickable toggle-variant-details pl-0 pr-0"
      data-url="{% url 'variants:small-variant-details' project=project.sodar_uuid case=entry.case_uuid release=entry.release chromosome=entry.chromosome position=entry.position reference=entry.reference alternative=entry.alternative database=database gene_id=entry.gene_id %}"
      data-toggle="collapse" data-target="#variant-details-{{ forloop.counter0 }}" aria-expanded="false" aria-controls="variant-details-{{ forloop.counter0 }}" aria-hidden="true">
    <i class="fa fa-fw fa-chevron-right"></i>
  </td>
  {# rank #}
  <td class="text-nowrap text-right text-muted">
      #{{ forloop.counter }}
  </td>
  {# bookmark #}
  {% if not training_mode %}
  <td class="bookmark pl-0 pr-0 text-nowrap">
    <i class="fa fa-fw {% if entry.flag_count %}fa-bookmark{% else %}fa-bookmark-o{% endif %} text-muted variant-bookmark"
       data-variant="{{ entry|smallvar_description }}" data-project="{{ project.sodar_uuid }}" data-case="{{ entry.case_uuid }}"></i>
    <i class="fa fa-fw {% if entry.comment_count %}fa-comment{% else %}fa-comment-o{% endif %} text-muted variant-comment"
       data-variant="{{ entry|smallvar_description }}" data-project="{{ project.sodar_uuid }}" data-case="{{ entry.case_uuid }}"></i>
  </td>
  {% else %}
  <td></td>
  {% endif %}
  {# databases #}
  <td class="pl-0 pr-0 text-nowrap">
    {# dbSNP Indicator #}
    {% if entry.rsid %}
      <a target="_blank" href="https://www.ncbi.nlm.nih.gov/projects/SNP/snp_ref.cgi?rs={{ entry.rsid|slice:'2:' }}">
    {% endif %}
      <i class="text-muted fa fa-fw fa-database"
        {% if entry.rsid %}
          data-toggle="tooltip"
          data-placement="top"
          title="See {{ entry.rsid }} in dbSNP"
       {% else %}
        style="opacity: 0.2"
       {% endif %}
      ></i>{% if entry.rsid %}</a>
    {% endif %}

    {% include "variants/filter_result/clinvar_indicator.html" %}
    {% include "variants/filter_result/hgmd_public_indicator.html" %}
  </td>
  <td>chr{{ entry.chromosome }}:{{ entry.position|intcomma }}</td>
  <td>{{ entry.reference|truncatechars:9 }}</td>
  <td>{{ entry.alternative|truncatechars:9 }}</td>
  <td class="detail-exac">
    {{ entry.exac_frequency|floatformat:5|default:"-" }}
  </td>
  <td class="detail-gnomad-exomes">
    {{ entry.gnomad_exomes_frequency|floatformat:5|default:"-" }}
  </td>
  <td class="detail-gnomad-genomes">
    {{ entry.gnomad_genomes_frequency|floatformat:5|default:"-" }}
  </td>
  <td class="detail-thousand-genomes">
    {{ entry.thousand_genomes_frequency|floatformat:5|default:"-" }}
  </td>
  <td class="detail-exac text-right">
    {{ entry.exac_homozygous|default_if_none:"-" }}
  </td>
  <td class="detail-gnomad-exomes text-right">
    {{ entry.gnomad_exomes_homozygous|default_if_none:"-" }}
  </td>
  <td class="detail-gnomad-genomes text-right">
    {{ entry.gnomad_genomes_homozygous|default_if_none:"-" }}
  </td>
  <td class="detail-thousand-genomes text-right">
    {{ entry.thousand_genomes_homozygous|default_if_none:"-" }}
  </td>
  <td class="detail-inhouse text-right">
    {{ entry.inhouse_carriers|default_if_none:"-" }}
  </td>
  <td class="detail-inhouse text-right">
    {{ entry.inhouse_hom_alt|default_if_none:"-" }}
  </td>
  <td class="pl-3 pr-3">
    {% if not entry.symbol %}
      -
    {% else %}
      <div class="btn-group sodar-list-btn-group">
        <button
          type="button"
          title="Go to locus in IGV"
          class="btn btn-outline-dark sodar-list-btn">
          {{ entry.symbol|default:"." }}
        </button>
        <button type="button" class="btn btn-sm btn-outline-dark dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <span class="sr-only">Toggle Dropdown</span>
        </button>
        <div class="dropdown-menu dropdown-menu-right">
          <a class="dropdown-item" href="https://www.omim.org/search/?search={{ entry.symbol }}" target="_blank">
            Gene @OMIM
          </a>
          <a class="dropdown-item" href="https://www.genecards.org/cgi-bin/carddisp.pl?gene={{ entry.symbol }}" target="_blank">
            Gene @GeneCards
          </a>
          <a class="dropdown-item" href="https://www.ncbi.nlm.nih.gov/gene/?term=({{ entry.symbol }}+AND+&quot;Homo+sapiens&quot;)" target="_blank">
            Gene @Entrez
          </a>
          <a class="dropdown-item" href="https://www.genenames.org/cgi-bin/gene_symbol_report?match={{ entry.symbol }}" target="_blank">
            Gene @HGNC
          </a>
          <a class="dropdown-item" href="http://www.hgmd.cf.ac.uk/ac/gene.php?gene={{ entry.symbol }}" target="_blank">
            Gene @HGMD Public
          </a>
          <a class="dropdown-item" href="https://www.proteinatlas.org/search/{{ entry.symbol }}" target="_blank">
            Gene @ProteinAtlas
          </a>
        </div>
      </div>
    {% endif %}
    {% if entry.acmg_symbol %}
      <i class="pl-2 fa fa-user-md text-danger" data-toggle="tooltip" data-placement="top" title="Gene in ACMG"></i>
    {% else %}
      <i class="pl-2 fa fa-user-md text-muted" style="opacity: 0.2"></i>
    {% endif %}
  </td>
  {% if has_phenotype_scores %}
    <td class="text-nowrap">
      {{ entry.phenotype_score|floatformat:3 }}
      <span class="text-muted">(#{{ entry.phenotype_rank }})</span>
    </td>
  {% endif %}
  {% if has_pathogenicity_scores %}
    <td class="text-nowrap">
      {{ entry.pathogenicity_score|floatformat:1 }}
      <span class="text-muted">(#{{ entry.pathogenicity_rank }})</span>
    </td>
  {% endif %}
  {% if has_phenotype_scores and has_pathogenicity_scores %}
    <td class="text-nowrap">
      {{ entry.joint_score|floatformat:1 }}
      <span class="text-muted">(#{{ entry.joint_rank }})</span>
    </td>
  {% endif %}
  <td>
    <span data-toggle="tooltip" title="{{ entry.effect|join:', ' }}">
      {{ entry.hgvs_p|default:"-"|truncatechars:15  }}
    </span>
  </td>
  {% if query_type == "case" %}
    {# pedigree members #}
    {% for member in pedigree %}
      {% include "variants/filter_result/_gt_field.html" with name=member.patient %}
    {% endfor %}
  {% else %}  {# query_type == "project" #}
    <td style="max-width: 120px;">
      <div class="sodar-overflow-container sodar-overflow-hover">
        {{ entry.sample_name|only_source_name }}
      </div>
    </td>
    {% include "variants/filter_result/_gt_field.html" with name=entry.sample_name %}
  {% endif %}
  <td>
    <div class="btn-group sodar-list-btn-group pr-2">
      <a
        href="javascript:mutationTaster('chr{{ entry.chromosome }}', {{ entry.position }}, '{{ entry.reference }}', '{{ entry.alternative }}');"
        data-toggle="tooltip"
        title="Open variant in MutationTaster"
        class="btn btn-primary sodar-list-btn">
        MT
      </a>
      <button
        type="button"
        onclick="javascript:$.ajax({url: 'http://127.0.0.1:60151/goto?locus=chr{{ entry.chromosome }}:{{ entry.position }}-{{ entry.position }}'})"
        title="Go to locus in IGV"
        class="btn btn-secondary sodar-list-btn">
        IGV
      </button>
      <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split sodar-list-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <span class="sr-only">Toggle Dropdown</span>
      </button>
      <div class="dropdown-menu dropdown-menu-right" style="z-index: 1030;">
        <a class="dropdown-item" href="https://genome-euro.ucsc.edu/cgi-bin/hgTracks?db=hg19&position={{ entry.chromosome }}:{{ entry.position }}-{{ entry.position }}" target="_blank">
          Locus @UCSC
        </a>
        <a class="dropdown-item" href="https://grch37.ensembl.org/Homo_sapiens/Location/View?r={{ entry.chromosome }}:{{ entry.position }}-{{ entry.position }}"
        <a class="dropdown-item" href="http://dgv.tcag.ca/gb2/gbrowse/dgv2_hg19/?name={{ entry.chromosome }}:{{ entry.position }}-{{ entry.position }};search=Search" target="_blank">
          Locus @DGV
        </a>
        <a class="dropdown-item" href="http://exac.broadinstitute.org/region/{{ entry.chromosome }}-{{ entry.position }}-{{ entry.position }}" target="_blank">
          Locus @ ExAC
        </a>
        <a class="dropdown-item" href="http://gnomad.broadinstitute.org/region/{{ entry.chromosome }}-{{ entry.position }}-{{ entry.position }}" target="_blank">
          Locus @ gnomAD
        </a>
        <div class="dropdown-divider"></div>
        <a href="javascript:humanSpliceFinder('{{ entry.symbol }}', '{{ entry.hgvs_c }}');"
          data-toggle="tooltip"
          title="Query Human Splice Finder"
          class="dropdown-item">
          Query Human Splice Finder
        </a>
        <a href="https://varseak.bio/ssp.php?gene={{ entry.symbol }}&hgvs={{ entry.hgvs_c }}"
          data-toggle="tooltip"
          title="Query varSEAK Splice Site Prediction"
          target="_blank"
          class="dropdown-item">
          Query varSEAK Splicing
        </a>
        {% if "missense_variant" in entry.effect %}
          <a href="javascript:polyPhen2('{{ entry.symbol }}', '{{ entry.hgvs_p }}');"
            data-toggle="tooltip"
            title="Query PolyPhen 2"
            class="dropdown-item">
            Query PolyPhen 2
          </a>
        {% else %}
          <span class="dropdown-item disabled">
            PolyPhen 2: missense only
          </span>
        {% endif %}
      </div>
    </div>
  </td>
</tr>
